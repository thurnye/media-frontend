<div class="cad-backdrop" (click)="onBackdropClick($event)">
  <div class="cad-dialog">

    <!-- ── Header ── -->
    <div class="cad-header">
      @if (step() === 'connect') {
        <button class="cad-back-btn" (click)="step.set('select')" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
          </svg>
        </button>
      }
      <h2 class="cad-title">{{ step() === 'select' ? 'Add Account' : 'Connect New Account' }}</h2>
      <button class="cad-close-btn" (click)="close.emit()" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </svg>
      </button>
    </div>

    <div class="cad-body">
      @if (connecting()) {
        <!-- Redirect spinner -->
        <div class="cad-connecting">
          <div class="cad-spinner"></div>
          <p class="cad-connecting-text">Redirecting to authorization...</p>
        </div>

      } @else if (step() === 'select') {
        <!-- Step 1: Existing accounts -->
        @if (availableAccounts().length > 0) {
          <p class="cad-hint">Select accounts to link to this workspace:</p>
          <div class="cad-account-list">
            @for (account of availableAccounts(); track account.id) {
              <label class="cad-account-row" [class.cad-account-row--selected]="isSelected(account.id)">
                <input
                  type="checkbox"
                  class="cad-checkbox"
                  [checked]="isSelected(account.id)"
                  (change)="toggleSelection(account.id)"
                />
                <span class="cad-account-icon" [style.background]="getPlatformColor(account.platform)">
                  {{ account.platform.charAt(0).toUpperCase() }}
                </span>
                <span class="cad-account-info">
                  <span class="cad-account-name">{{ account.displayName }}</span>
                  <span class="cad-account-meta">{{ getPlatformLabel(account.platform) }}</span>
                </span>
              </label>
            }
          </div>
        } @else {
          <p class="cad-hint">No existing accounts available to link. Connect a new one below.</p>
        }

        <div class="cad-footer">
          @if (availableAccounts().length > 0 && selected().size > 0) {
            <button
              class="cad-btn cad-btn--connect"
              [disabled]="saving()"
              (click)="linkSelected()"
              type="button"
            >
              Link selected ({{ selected().size }})
            </button>
          }
          <button class="cad-btn cad-btn--secondary" (click)="goToConnect()" type="button">
            Connect new account
          </button>
        </div>

      } @else {
        <!-- Step 2: Platform OAuth grid -->
        <p class="cad-hint">Select a platform to connect via OAuth:</p>
        <div class="cad-platform-grid">
          @for (p of platforms; track p.type) {
            <button
              class="cad-platform-btn"
              [style.--platform-color]="p.color"
              (click)="selectPlatform(p)"
              type="button"
            >
              <span class="cad-platform-icon" [style.background]="p.color">
                {{ p.label.charAt(0) }}
              </span>
              <span class="cad-platform-label">{{ p.label }}</span>
            </button>
          }
        </div>
      }
    </div>

  </div>
</div>
